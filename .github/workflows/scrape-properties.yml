name: Scrape Properties

on:
  schedule:
    # Run every 6 hours (UTC timezone)
    # Format: minute hour day month day-of-week
    # This runs at: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allows manual trigger from GitHub Actions UI
    inputs:
      source:
        description: 'Property source to scrape (all, private_property, property24, facebook)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - private_property
          - property24
          - facebook
      city:
        description: 'City to scrape (e.g., cape-town)'
        required: false
        default: 'cape-town'
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    name: Trigger Property Scraping
    timeout-minutes: 10
    steps:
      - name: Trigger Supabase Edge Function
        run: |
          echo "ğŸš€ Triggering property scraping..."
          echo "Source: ${{ github.event.inputs.source || 'all' }}"
          echo "City: ${{ github.event.inputs.city || 'cape-town' }}"
          echo ""
          
          # Prepare request body
          SOURCE="${{ github.event.inputs.source || 'all' }}"
          CITY="${{ github.event.inputs.city || 'cape-town' }}"
          REQUEST_BODY=$(cat <<EOF
          {
            "source": "$SOURCE",
            "city": "$CITY"
          }
          EOF
          )
          
          echo "Making request to Supabase Edge Function..."
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            --max-time 300 \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d "$REQUEST_BODY" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/scrape-properties")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Response HTTP Code: $HTTP_CODE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Response Body:"
          
          # Try to format JSON if jq is available, otherwise just print
          if command -v jq &> /dev/null; then
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "$BODY"
          fi
          
          echo ""
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Scraping job triggered successfully!"
            echo "Check your Supabase dashboard to see the results."
            exit 0
          else
            echo "âŒ Failed to trigger scraping job (HTTP $HTTP_CODE)"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "TROUBLESHOOTING GUIDE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ "$HTTP_CODE" = "404" ]; then
              echo "ğŸ”§ Issue: Edge function not found (404)"
              echo ""
              echo "Solution: Deploy the Edge Function"
              echo "1. Get your Supabase access token: https://app.supabase.com/account/tokens"
              echo "2. Run: npx supabase functions deploy scrape-properties --project-ref YOUR_PROJECT_REF"
              echo "3. See DEPLOY_EDGE_FUNCTION.md for detailed instructions"
            elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
              echo "ğŸ”§ Issue: Authentication failed ($HTTP_CODE)"
              echo ""
              echo "Solution: Check your GitHub secrets"
              echo "1. Go to: https://github.com/SkelmCallum/PropertyApp/settings/secrets/actions"
              echo "2. Verify SUPABASE_SERVICE_ROLE_KEY is the service_role key (starts with eyJ...)"
              echo "3. Make sure it's not the anon key"
              echo "4. Check for extra spaces or newlines"
            elif [ -z "$HTTP_CODE" ]; then
              echo "ğŸ”§ Issue: No response from server"
              echo ""
              echo "Solution: Check your SUPABASE_URL secret"
              echo "1. Go to: https://github.com/SkelmCallum/PropertyApp/settings/secrets/actions"
              echo "2. Verify SUPABASE_URL is correct (format: https://xxxxx.supabase.co)"
              echo "3. Make sure there are no trailing slashes"
            else
              echo "ğŸ”§ Issue: Unexpected error (HTTP $HTTP_CODE)"
              echo ""
              echo "Check:"
              echo "  1. SUPABASE_URL secret is correct"
              echo "  2. SUPABASE_SERVICE_ROLE_KEY secret is correct"
              echo "  3. Edge function 'scrape-properties' is deployed"
              echo "  4. See validate-workflow-setup.md for full checklist"
            fi
            
            echo ""
            echo "For more help, see: .github/GITHUB_ACTIONS_SETUP.md"
            exit 1
          fi

